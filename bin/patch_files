#!/bin/sh

usage () 
{
    echo "$(basename $0) [set|unset]" >&2
    echo "- set: patch the files so that the angular compilation can work correctly" >&2
    echo "- unset: restore the files in a state they can be edited correctly" >&2
    exit 2
}

case "$1" in 
    set)
        echo -n Patching vis-network...
        sed -i -e 's!^\(import .* from  *["'"'"']vis-network/peer["'"'"'].*\)!//\1!' \
            -e 's!^//\(import .* from  *["'"'"']vis-network/dist/vis-network.js["'"'"'].*\)!\1!' \
            -e 's!^\(import .* from  *["'"'"']vis-data/peer["'"'"'].*\)!//\1!' \
            -e 's!^//\(import .* from  *["'"'"']vis-data/dist/esm.js["'"'"'].*\)!\1!' \
            src/components/dmj-zwave-config/dmj-zwave-config.ts
        echo
        echo -n Recompiling intl-messageformat...
        projdir=$(dirname "$0")/..
        projdir=$(realpath "$projdir")
        source="$projdir/node_modules/intl-messageformat/intl-messageformat.esm.js"
        target="$projdir/src/recompiled/intl-messageformat.esm.js"
        [  "$target" -nt "$source" ] || (
            cd / # to have no tconfig.json
            # use /usr/bin/tsc (not node_modules/typescript/bin/tsc) because too old to compile this file
            /usr/bin/tsc --allowJS -outDir $(dirname "$target") $projdir/node_modules/intl-messageformat/intl-messageformat.esm.js
        )
        echo
        echo -n Patching intl-messageformat...
        sed -i -e 's!^\(import .* from  *["'"'"']intl-messageformat["'"'"'].*\)!//\1!' \
            -e 's!^//\(import .* from  *["'"'"']../recompiled/intl-messageformat.esm.js["'"'"'].*\)!\1!' \
            src/directives/dmj-widget-host.ts
        echo
        ;;
    unset)
        echo -n Unpatching vis-network...
        sed -i -e 's!^//\(import .* from  *["'"'"']vis-network/peer["'"'"'].*\)!\1!' \
            -e 's!^\(import .* from  *["'"'"']vis-network/dist/vis-network.js["'"'"'].*\)!//\1!' \
            -e 's!^//\(import .* from  *["'"'"']vis-data/peer["'"'"'].*\)!\1!' \
            -e 's!^\(import .* from  *["'"'"']vis-data/dist/esm.js["'"'"'].*\)!//\1!' \
            src/components/dmj-zwave-config/dmj-zwave-config.ts
        echo
        echo -n Unpatching intl-messageformat...
        sed -i -e 's!^//\(import .* from  *["'"'"']intl-messageformat["'"'"'].*\)!\1!' \
            -e 's!^\(import .* from  *["'"'"']../recompiled/intl-messageformat.esm.js["'"'"'].*\)!//\1!' \
            src/directives/dmj-widget-host.ts
        echo
        ;;
    *)
        usage
        ;;
esac


